<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pknu.ebtalk.mappers.chatting.IChattingMapper">
    <!-- ChatRoom 테이블에 새로운 채팅방 삽입 -->
    <insert id="insertChatRoom" parameterType="com.pknu.ebtalk.dto.chatting.ChatRoomDTO">
        INSERT INTO
        ChatRoom(NO, NAME, TYPE, CREATE_AT)
        VALUES
            (
             #{NO},
             #{NAME},
             #{TYPE},
             #{CREATE_AT}
            )
    </insert>
    <!-- ChatRoomUser 테이블에 새로운 사용자 삽입 -->
    <insert id="insertChatRoomUser" parameterType="com.pknu.ebtalk.dto.chatting.ChatRoomUserDTO">
        INSERT INTO
            ChatRoom(CHAT_ROOM_ID, USER_ID)
        VALUES
            (
                #{CHAT_ROOM_ID},
                #{USER_ID}
            )
    </insert>
    <!-- Message 테이블에 새로운 메시지 삽입 -->
    <insert id="insertMessage" parameterType="com.pknu.ebtalk.dto.chatting.MessageDTO">
        INSERT INTO
            ChatRoom(NO, CONTENT, FROM_ID, TO_ID, CHAT_ROOM_ID, FILE_NO, MESSAGE_TYPE, CREATE_AT, READ_YN)
        VALUES
            (
                #{NO},
                #{CONTENT},
                #{FROM_ID},
                #{TO_ID},
                #{CHAT_ROOM_ID},
                #{FILE_NO},
                #{MESSAGE_TYPE},
                #{CREATE_AT},
                #{READ_YN}
            )
    </insert>
    <!-- Attachment 테이블에 새로운 첨부파일 삽입 -->
    <insert id="insertAttachment" parameterType="com.pknu.ebtalk.dto.chatting.AttachmentDTO">
        INSERT INTO
            ChatRoom(NO, FILE_PATH, FILE_TYPE, CREATE_AT)
        VALUES
            (
                #{NO},
                #{FILE_PATH},
                #{FILE_TYPE},
                #{CREATE_AT}
            )
    </insert>

    <!-- ====================================================================  -->

    <!-- ChatRoom 테이블에서 채팅방 정보 조회 -->
    <select id="selectRoomList" resultType="com.pknu.ebtalk.dto.chatting.ChatRoomDTO">
        SELECT NO, NAME, TYPE, CREATE_AT
        FROM ChatRoom
        WHERE NO = #{NO}
    </select>

    <!-- ChatRoomUser 테이블에서 특정 채팅방의 사용자 조회 -->
    <select id="selectChatRoomUser" resultType="com.pknu.ebtalk.dto.chatting.ChatRoomUserDTO">
        SELECT CHAT_ROOM_ID, USER_ID
        FROM ChatRoomUser
        WHERE CHAT_ROOM_ID = #{CHAT_ROOM_ID}
    </select>

    <!-- Message 테이블에서 특정 채팅방의 메시지 조회 -->
    <select id="selectMessageList" resultType="com.pknu.ebtalk.dto.chatting.MessageDTO">
        SELECT NO, CONTENT, FROM_ID, TO_ID, CHAT_ROOM_ID, FILE_NO, MESSAGE_TYPE, CREATE_AT, READ_YN
        FROM Message
        WHERE CHAT_ROOM_ID = #{CHAT_ROOM_ID}
        ORDER BY CREATE_AT
    </select>

    <!-- ChatRoomUser 테이블에서 특정 사용자가 속한 채팅방 목록 조회 -->
    <select id="selectUserChatRooms" resultType="com.pknu.ebtalk.dto.chatting.ChatRoomDTO">
        SELECT c.NO, c.NAME, c.TYPE, c.CREATE_AT
        FROM ChatRoom c
                 INNER JOIN ChatRoomUser u ON c.NO = u.CHAT_ROOM_ID
        WHERE u.USER_ID = #{USER_ID}
    </select>

    <!-- Message 테이블에서 특정 메시지의 읽음 상태 업데이트 -->
    <update id="updateReadFlag">
        UPDATE Message
        SET READ_YN = 'Y'
        WHERE NO = #{NO}
    </update>

    <!-- ChatRoom 테이블에서 특정 채팅방의 이름 업데이트 -->
    <update id="updateChatRoomName">
        UPDATE ChatRoom
        SET NAME = #{NAME}
        WHERE NO = #{NO}
    </update>

    <!-- Message 테이블에서 특정 메시지 삭제 -->
    <delete id="deleteMessage">
        DELETE FROM Message
        WHERE NO = #{NO}
    </delete>

    <!-- ChatRoom 테이블에서 특정 채팅방 삭제 -->
    <delete id="deleteChatRoom">
        DELETE FROM ChatRoom
        WHERE NO = #{NO}
    </delete>

    <!-- ChatRoomUser 테이블에서 특정 사용자 삭제 -->
    <delete id="deleteChatRoomUser">
        DELETE FROM ChatRoomUser
        WHERE CHAT_ROOM_ID = #{CHAT_ROOM_ID} AND USER_ID = #{USER_ID}
    </delete>

</mapper>